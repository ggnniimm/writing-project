#!/bin/bash
DIARY_FILE="git_diary.md"

# 1. Stage all changes first
git add .

# 2. Get Smart Suggestion
SUGGESTION=$(python3 update_diary.py --suggest)
# Suggestion format: category|message|details (newline separated)
IFS='|' read -r AUTO_CAT AUTO_MSG AUTO_DETAILS <<< "$SUGGESTION"

# Check if arguments are provided (Non-Interactive Mode)
if [ "$#" -gt 0 ]; then
    MANUAL_LOG="$1"
    if [ "$#" -gt 1 ]; then
        USER_STORY="$2"
    else
        USER_STORY=""
    fi
    CATEGORY="content"  # Default category for auto-push
    DETAILS=""
    
    echo "ðŸ¤– Auto-Push Mode Activated"
    echo "ðŸ“ Message: $MANUAL_LOG"
    if [ ! -z "$USER_STORY" ]; then
        echo "ðŸ“– Context: $USER_STORY"
    fi
else
    # Interactive Mode
    echo "ðŸ¤– à¸£à¸°à¸šà¸šà¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“..."
    echo "---------------------------------------------------"
    echo "ðŸ“‚ à¸«à¸¡à¸§à¸”à¸‡à¸²à¸™: $AUTO_CAT"
    echo "ðŸ“ à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡: $AUTO_MSG"
    echo "---------------------------------------------------"
    echo "ðŸ’¡ à¸à¸” [Enter] à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰ à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œà¹ƒà¸«à¸¡à¹ˆà¹€à¸žà¸·à¹ˆà¸­à¹à¸à¹‰à¹„à¸‚"
    read -p "ðŸ‘‰ Your Log: " USER_LOG
fi

if [ -z "$MANUAL_LOG" ]; then
    if [ -z "$USER_LOG" ]; then
        MANUAL_LOG="$AUTO_MSG"
        CATEGORY="$AUTO_CAT"
        DETAILS="$AUTO_DETAILS"
    else
        MANUAL_LOG="$USER_LOG"
        CATEGORY="$AUTO_CAT"
        DETAILS="$AUTO_DETAILS"
    fi
fi

if [ "$#" -eq 0 ]; then
    echo "ðŸ’¬ à¹€à¸žà¸´à¹ˆà¸¡à¸šà¸£à¸´à¸šà¸—à¸‚à¸­à¸‡à¸‡à¸²à¸™ (Context) - à¸—à¸³à¹„à¸¡? à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£? (à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸!) - à¸à¸” [Enter] à¹€à¸žà¸·à¹ˆà¸­à¸‚à¹‰à¸²à¸¡"
    read -p "ðŸ‘‰ Context: " USER_STORY
fi

if [ ! -z "$USER_STORY" ]; then
    # Combine User Story with Auto File Details
    DETAILS="$USER_STORY\n$DETAILS"
fi

# 0. Generate HTML
echo "ðŸŽ¨ Generating Premium HTML Documents..."
python3 generate_html.py

# 1. Update Diary
echo "ðŸ¤– Updating AI Diary..."
python3 update_diary.py "$CATEGORY" "$MANUAL_LOG" "$DETAILS"

# 2. Stage EVERYTHING again (to capture generated artifacts)
git add .

# Commit
git commit -m "$MANUAL_LOG"
echo "âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ Diary à¹à¸¥à¸° Commit (à¸£à¸§à¸¡à¹„à¸Ÿà¸¥à¹Œà¸‡à¸²à¸™) à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢"

# 3. à¸ªà¹ˆà¸‡à¸‡à¸²à¸™à¸‚à¸¶à¹‰à¸™ GitHub
echo "ðŸš€ à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡à¸‡à¸²à¸™à¸‚à¸¶à¹‰à¸™ GitHub..."
git push
