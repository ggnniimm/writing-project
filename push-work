#!/bin/bash
DIARY_FILE="git_diary.md"

# 1. Stage all changes first
git add .

# 2. Get Smart Suggestion
SUGGESTION=$(python3 update_diary.py --suggest)
# Suggestion format: category|message|details (newline separated)
IFS='|' read -r AUTO_CAT AUTO_MSG AUTO_DETAILS <<< "$SUGGESTION"

# Check if arguments are provided (Non-Interactive Mode)
if [ "$#" -gt 0 ]; then
    MANUAL_LOG="$1"
    if [ "$#" -gt 1 ]; then
        USER_STORY="$2"
    else
        USER_STORY=""
    fi
    CATEGORY="content"  # Default category for auto-push
    DETAILS=""
    
    echo "ðŸ¤– à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸š Auto-Push (à¹‚à¸«à¸¡à¸”à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´)"
    echo "ðŸ“ à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸šà¸±à¸™à¸—à¸¶à¸: $MANUAL_LOG"
    if [ ! -z "$USER_STORY" ]; then
        echo "ðŸ“– à¸šà¸£à¸´à¸šà¸—à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡: $USER_STORY"
    fi
else
    # Interactive Mode
    echo "ðŸ¤– à¸£à¸°à¸šà¸šà¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“..."
    echo "---------------------------------------------------"
    echo "ðŸ“‚ à¸«à¸¡à¸§à¸”à¸‡à¸²à¸™: $AUTO_CAT"
    echo "ðŸ“ à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸™à¸°à¸™à¸³: $AUTO_MSG"
    echo "---------------------------------------------------"
    echo "ðŸ’¡ à¸à¸” [Enter] à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰ à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œà¹ƒà¸«à¸¡à¹ˆà¹€à¸žà¸·à¹ˆà¸­à¹à¸à¹‰à¹„à¸‚"
    read -p "ðŸ‘‰ à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¸­à¸‡à¸„à¸¸à¸“ (à¸ à¸²à¸©à¸²à¹„à¸—à¸¢): " USER_LOG
fi

if [ -z "$MANUAL_LOG" ]; then
    if [ -z "$USER_LOG" ]; then
        MANUAL_LOG="$AUTO_MSG"
        CATEGORY="$AUTO_CAT"
        DETAILS="$AUTO_DETAILS"
    else
        MANUAL_LOG="$USER_LOG"
        CATEGORY="$AUTO_CAT"
        DETAILS="$AUTO_DETAILS"
    fi
fi

if [ "$#" -eq 0 ]; then
    echo "ðŸ’¬ à¹€à¸žà¸´à¹ˆà¸¡à¸šà¸£à¸´à¸šà¸—à¸‚à¸­à¸‡à¸‡à¸²à¸™ (Context) - à¸—à¸³à¹„à¸¡? à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£? (à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸!) - à¸à¸” [Enter] à¹€à¸žà¸·à¹ˆà¸­à¸‚à¹‰à¸²à¸¡"
    read -p "ðŸ‘‰ à¸šà¸£à¸´à¸šà¸— (à¸ à¸²à¸©à¸²à¹„à¸—à¸¢): " USER_STORY
fi

if [ ! -z "$USER_STORY" ]; then
    # Combine User Story with Auto File Details
    DETAILS="$USER_STORY\n$DETAILS"
fi

# 0. Generate HTML
echo "ðŸŽ¨ à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸­à¸à¸ªà¸²à¸£ HTML à¸£à¸°à¸”à¸±à¸šà¸žà¸£à¸µà¹€à¸¡à¸µà¸¢à¸¡ (Smart Build)..."
python3 generate_html.py

# 1. Update Diary
echo "ðŸ¤– à¸à¸³à¸¥à¸±à¸‡à¸­à¸±à¸›à¹€à¸”à¸• Diary à¸­à¸±à¸ˆà¸‰à¸£à¸´à¸¢à¸°..."
python3 update_diary.py "$CATEGORY" "$MANUAL_LOG" "$DETAILS"

# 2. Stage EVERYTHING again (to capture generated artifacts)
git add .

# Commit
git commit -m "$MANUAL_LOG"
echo "âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ Diary à¹à¸¥à¸° Commit à¹„à¸Ÿà¸¥à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢"

# 3. Show Latest Log Verification
echo "---------------------------------------------------"
echo "ðŸ‘€ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸—à¸µà¹ˆà¸–à¸¹à¸à¸ˆà¸±à¸”à¹€à¸à¹‡à¸š:"
python3 update_diary.py --read-latest
echo "---------------------------------------------------"

# 4. Push to GitHub
echo "ðŸš€ à¸à¸³à¸¥à¸±à¸‡à¸™à¸³à¸ªà¹ˆà¸‡à¸‚à¸¶à¹‰à¸™ GitHub..."
git push
